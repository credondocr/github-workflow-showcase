name: Sync Labels (Alternative)

on:
  push:
    branches: [ main ]
    paths: [ '.github/labels.yml' ]
  workflow_dispatch:

jobs:
  sync-labels:
    name: 🏷️ Sync Repository Labels (Robust)
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📋 Parse YAML configuration
        id: parse-yaml
        uses: mikefarah/yq@master
        with:
          cmd: yq eval -o=json '.[]' .github/labels.yml

      - name: 🔄 Sync labels with parsed config
        uses: actions/github-script@v7
        with:
          script: |
            // Parse the JSON output from yq
            const labelsConfig = `${{ steps.parse-yaml.outputs.result }}`.split('\n')
              .filter(line => line.trim())
              .map(line => JSON.parse(line));
            
            console.log(`📋 Found ${labelsConfig.length} labels to sync`);
            
            // Get existing labels
            const { data: existingLabels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const existingLabelNames = existingLabels.map(label => label.name);
            console.log(`📋 Found ${existingLabels.length} existing labels`);
            
            let created = 0;
            let updated = 0;
            let skipped = 0;
            
            // Process each label from config
            for (const labelConfig of labelsConfig) {
              const { name, color, description } = labelConfig;
              
              try {
                if (existingLabelNames.includes(name)) {
                  // Label exists, check if it needs updating
                  const existingLabel = existingLabels.find(l => l.name === name);
                  
                  if (existingLabel.color !== color || existingLabel.description !== description) {
                    await github.rest.issues.updateLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: name,
                      color: color,
                      description: description
                    });
                    console.log(`✏️ Updated label: ${name}`);
                    updated++;
                  } else {
                    console.log(`✅ Label already up-to-date: ${name}`);
                    skipped++;
                  }
                } else {
                  // Label doesn't exist, create it
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: name,
                    color: color,
                    description: description
                  });
                  console.log(`➕ Created label: ${name}`);
                  created++;
                }
              } catch (error) {
                console.error(`❌ Error processing label ${name}:`, error.message);
              }
            }
            
            console.log(`\n📊 Label Sync Summary:`);
            console.log(`➕ Created: ${created}`);
            console.log(`✏️ Updated: ${updated}`);
            console.log(`✅ Skipped (up-to-date): ${skipped}`);
            console.log(`📋 Total processed: ${labelsConfig.length}`);

      - name: ✅ Label sync complete
        run: |
          echo "🎉 Label synchronization completed!"
          echo "🏷️ All repository labels are now in sync with .github/labels.yml"
