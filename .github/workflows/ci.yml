name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Code Quality and Linting
  lint:
    name: ğŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ§¹ Verify dependencies
        run: go mod verify

      - name: ğŸ”§ Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: ğŸ¨ Check formatting
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "::error::The following files are not properly formatted:"
            gofmt -s -l .
            echo "Please run 'gofmt -s -w .' to fix formatting issues."
            exit 1
          fi

      - name: ğŸ” Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m



  # Build Verification
  build:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21', '1.22']
        os: [macos-latest]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ¹ Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ—ï¸ Build application
        run: go build -v ./...

      - name: ğŸ—ï¸ Build main executable
        run: go build -o github-workflow-showcase ./main.go

  # Testing
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ§ª Run unit tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: ğŸ“Š Generate coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: ğŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.out
            coverage.html

  # Ginkgo Tests (BDD)
  ginkgo-tests:
    name: ğŸ§ª Ginkgo BDD Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ”§ Install Ginkgo CLI
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest

      - name: ğŸ§ª Run Ginkgo tests
        run: ginkgo -r -v --race --randomize-all --randomize-suites --fail-on-pending --cover --coverprofile=ginkgo-coverage.out

      - name: ğŸ“Š Upload Ginkgo coverage
        uses: actions/upload-artifact@v4
        with:
          name: ginkgo-coverage
          path: ginkgo-coverage.out



  # Notification on Success
  notify-success:
    name: âœ… Success Notification
    runs-on: ubuntu-latest
    needs: [lint, build, test, ginkgo-tests]
    if: success()
    steps:
      - name: ğŸ‰ All checks passed
        run: |
          echo "ğŸ‰ All CI checks passed successfully!"
          echo "âœ… Code quality check: PASSED"
          echo "âœ… Build verification: PASSED"
          echo "âœ… Unit tests: PASSED"
          echo "âœ… Ginkgo BDD tests: PASSED"
