name: Auto Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

jobs:
  auto-label:
    name: ğŸ·ï¸ Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Get changed files
        id: changed-files
        run: |
          # Get the base and head commit SHAs
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          # Get list of changed files
          git diff --name-only $BASE_SHA..$HEAD_SHA > changed_files.txt
          
          echo "Changed files:"
          cat changed_files.txt
          
          # Count changes by area - using safer syntax
          MODELS_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '^models/' | wc -l || echo 0)
          CONTROLLERS_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '^controllers/' | wc -l || echo 0)
          ROUTES_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '^routes/' | wc -l || echo 0)
          TESTS_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep -E '(^tests/|_test\.go$)' | wc -l || echo 0)
          GITHUB_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '^\.github/' | wc -l || echo 0)
          DOCS_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep -E '\.(md|txt)$' | wc -l || echo 0)
          DEPS_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep -E '^(go\.(mod|sum)|Dockerfile)$' | wc -l || echo 0)
          CONFIG_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep -E '\.(yml|yaml|json|toml)$' | wc -l || echo 0)
          MAIN_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '^main\.go$' | wc -l || echo 0)
          
          echo "models_changed=$MODELS_CHANGED" >> $GITHUB_OUTPUT
          echo "controllers_changed=$CONTROLLERS_CHANGED" >> $GITHUB_OUTPUT
          echo "routes_changed=$ROUTES_CHANGED" >> $GITHUB_OUTPUT
          echo "tests_changed=$TESTS_CHANGED" >> $GITHUB_OUTPUT
          echo "github_changed=$GITHUB_CHANGED" >> $GITHUB_OUTPUT
          echo "docs_changed=$DOCS_CHANGED" >> $GITHUB_OUTPUT
          echo "deps_changed=$DEPS_CHANGED" >> $GITHUB_OUTPUT
          echo "config_changed=$CONFIG_CHANGED" >> $GITHUB_OUTPUT
          echo "main_changed=$MAIN_CHANGED" >> $GITHUB_OUTPUT
          
          # Calculate total changes
          TOTAL_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA | wc -l)
          LINES_ADDED=$(git diff --numstat $BASE_SHA..$HEAD_SHA | awk '{sum+=$1} END {print sum+0}')
          LINES_DELETED=$(git diff --numstat $BASE_SHA..$HEAD_SHA | awk '{sum+=$2} END {print sum+0}')
          
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
          
          # Check for specific file types - using safer syntax
          HAS_GO_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '\.go$' | wc -l || echo 0)
          HAS_SQL_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '\.sql$' | wc -l || echo 0)
          HAS_DOCKER_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep -E '^(Dockerfile|\.dockerignore)$' | wc -l || echo 0)
          
          echo "has_go_files=$HAS_GO_FILES" >> $GITHUB_OUTPUT
          echo "has_sql_files=$HAS_SQL_FILES" >> $GITHUB_OUTPUT
          echo "has_docker_files=$HAS_DOCKER_FILES" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Add area labels
        uses: actions/github-script@v7
        with:
          script: |
            const labelsToAdd = [];
            const labelsToRemove = [];
            
            // Define label mapping based on changed files
            const labelMappings = [
              {
                condition: ${{ steps.changed-files.outputs.models_changed }} > 0,
                label: 'area: models',
                color: '0E8A16',
                description: 'Changes to data models'
              },
              {
                condition: ${{ steps.changed-files.outputs.controllers_changed }} > 0,
                label: 'area: controllers',
                color: '1D76DB',
                description: 'Changes to controller logic'
              },
              {
                condition: ${{ steps.changed-files.outputs.routes_changed }} > 0,
                label: 'area: routes',
                color: 'B60205',
                description: 'Changes to route configuration'
              },
              {
                condition: ${{ steps.changed-files.outputs.tests_changed }} > 0,
                label: 'area: tests',
                color: 'F9C513',
                description: 'Changes to test files'
              },
              {
                condition: ${{ steps.changed-files.outputs.github_changed }} > 0,
                label: 'area: ci/cd',
                color: '5319E7',
                description: 'Changes to CI/CD workflows'
              },
              {
                condition: ${{ steps.changed-files.outputs.docs_changed }} > 0,
                label: 'area: documentation',
                color: '006B75',
                description: 'Changes to documentation'
              },
              {
                condition: ${{ steps.changed-files.outputs.deps_changed }} > 0,
                label: 'area: dependencies',
                color: 'E99695',
                description: 'Changes to dependencies'
              },
              {
                condition: ${{ steps.changed-files.outputs.config_changed }} > 0,
                label: 'area: configuration',
                color: 'C2E0C6',
                description: 'Changes to configuration files'
              },
              {
                condition: ${{ steps.changed-files.outputs.main_changed }} > 0,
                label: 'area: core',
                color: 'D93F0B',
                description: 'Changes to core application'
              }
            ];
            
            // Add size labels
            const totalChanges = ${{ steps.changed-files.outputs.lines_added }} + ${{ steps.changed-files.outputs.lines_deleted }};
            if (totalChanges < 10) {
              labelMappings.push({
                condition: true,
                label: 'size: XS',
                color: '00FF00',
                description: 'Extra small PR (< 10 lines)'
              });
            } else if (totalChanges < 30) {
              labelMappings.push({
                condition: true,
                label: 'size: S',
                color: '7CFC00',
                description: 'Small PR (< 30 lines)'
              });
            } else if (totalChanges < 100) {
              labelMappings.push({
                condition: true,
                label: 'size: M',
                color: 'FFD700',
                description: 'Medium PR (< 100 lines)'
              });
            } else if (totalChanges < 500) {
              labelMappings.push({
                condition: true,
                label: 'size: L',
                color: 'FF8C00',
                description: 'Large PR (< 500 lines)'
              });
            } else {
              labelMappings.push({
                condition: true,
                label: 'size: XL',
                color: 'FF0000',
                description: 'Extra large PR (>= 500 lines)'
              });
            }
            
            // Add type labels based on patterns
            if (${{ steps.changed-files.outputs.has_go_files }} > 0 && ${{ steps.changed-files.outputs.tests_changed }} === 0) {
              labelMappings.push({
                condition: true,
                label: 'needs tests',
                color: 'FBCA04',
                description: 'Missing test coverage'
              });
            }
            
            if (${{ steps.changed-files.outputs.has_docker_files }} > 0) {
              labelMappings.push({
                condition: true,
                label: 'area: docker',
                color: '2496ED',
                description: 'Changes to Docker configuration'
              });
            }
            
            // Function to ensure label exists
            async function ensureLabelExists(labelName, color, description) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName
                });
              } catch (error) {
                if (error.status === 404) {
                  // Label doesn't exist, create it
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color: color,
                    description: description
                  });
                  console.log(`Created new label: ${labelName}`);
                }
              }
            }
            
            // Process labels
            for (const mapping of labelMappings) {
              if (mapping.condition) {
                await ensureLabelExists(mapping.label, mapping.color, mapping.description);
                labelsToAdd.push(mapping.label);
              }
            }
            
            // Remove old size labels if new one is being added
            const sizeLabels = ['size: XS', 'size: S', 'size: M', 'size: L', 'size: XL'];
            const newSizeLabel = labelsToAdd.find(label => sizeLabels.includes(label));
            if (newSizeLabel) {
              const oldSizeLabels = sizeLabels.filter(label => label !== newSizeLabel);
              labelsToRemove.push(...oldSizeLabels);
            }
            
            // Get current labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const currentLabelNames = currentLabels.map(label => label.name);
            
            // Remove old labels
            for (const labelToRemove of labelsToRemove) {
              if (currentLabelNames.includes(labelToRemove)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: labelToRemove
                });
                console.log(`Removed label: ${labelToRemove}`);
              }
            }
            
            // Add new labels
            const newLabels = labelsToAdd.filter(label => !currentLabelNames.includes(label));
            if (newLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: newLabels
              });
              console.log(`Added labels: ${newLabels.join(', ')}`);
            }
            
            // Log summary
            console.log(`\nğŸ“Š PR Analysis Summary:`);
            console.log(`ğŸ“ Total files changed: ${{ steps.changed-files.outputs.total_files }}`);
            console.log(`â• Lines added: ${{ steps.changed-files.outputs.lines_added }}`);
            console.log(`â– Lines deleted: ${{ steps.changed-files.outputs.lines_deleted }}`);
            console.log(`ğŸ·ï¸ Labels added: ${labelsToAdd.join(', ') || 'None'}`);
            console.log(`ğŸ—‘ï¸ Labels removed: ${labelsToRemove.join(', ') || 'None'}`);

      - name: ğŸ’¬ Comment PR analysis
        uses: actions/github-script@v7
        with:
          script: |
            // Only comment if this is a new PR or if it's been significantly updated
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComments = comments.filter(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ¤– **Auto-Labeler Analysis**')
            );
            
            // Only post analysis comment for new PRs or if no bot comment exists
            if (context.payload.action === 'opened' || botComments.length === 0) {
              const totalChanges = ${{ steps.changed-files.outputs.lines_added }} + ${{ steps.changed-files.outputs.lines_deleted }};
              
              let sizeEmoji = 'ğŸ“¦';
              let sizeText = 'Unknown';
              if (totalChanges < 10) { sizeEmoji = 'ğŸŸ¢'; sizeText = 'Extra Small'; }
              else if (totalChanges < 30) { sizeEmoji = 'ğŸŸ¡'; sizeText = 'Small'; }
              else if (totalChanges < 100) { sizeEmoji = 'ğŸŸ '; sizeText = 'Medium'; }
              else if (totalChanges < 500) { sizeEmoji = 'ğŸ”´'; sizeText = 'Large'; }
              else { sizeEmoji = 'ğŸŸ£'; sizeText = 'Extra Large'; }
              
              const analysisComment = `ğŸ¤– **Auto-Labeler Analysis**
              
              ${sizeEmoji} **PR Size**: ${sizeText} (${totalChanges} total line changes)
              
              ğŸ“Š **Changes Summary**:
              - ğŸ“ Files changed: ${{ steps.changed-files.outputs.total_files }}
              - â• Lines added: ${{ steps.changed-files.outputs.lines_added }}
              - â– Lines deleted: ${{ steps.changed-files.outputs.lines_deleted }}
              
              ğŸ¯ **Areas Modified**:
              ${${{ steps.changed-files.outputs.models_changed }} > 0 ? '- ğŸ—ƒï¸ Models' : ''}
              ${${{ steps.changed-files.outputs.controllers_changed }} > 0 ? '- ğŸ® Controllers' : ''}
              ${${{ steps.changed-files.outputs.routes_changed }} > 0 ? '- ğŸ›£ï¸ Routes' : ''}
              ${${{ steps.changed-files.outputs.tests_changed }} > 0 ? '- ğŸ§ª Tests' : ''}
              ${${{ steps.changed-files.outputs.github_changed }} > 0 ? '- âš™ï¸ CI/CD' : ''}
              ${${{ steps.changed-files.outputs.docs_changed }} > 0 ? '- ğŸ“š Documentation' : ''}
              ${${{ steps.changed-files.outputs.deps_changed }} > 0 ? '- ğŸ“¦ Dependencies' : ''}
              ${${{ steps.changed-files.outputs.config_changed }} > 0 ? '- âš™ï¸ Configuration' : ''}
              ${${{ steps.changed-files.outputs.main_changed }} > 0 ? '- ğŸ¯ Core Application' : ''}
              
              Labels have been automatically applied based on the changes detected. ğŸ·ï¸`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: analysisComment
              });
            }

      - name: ğŸ’¬ Comment label summary
        uses: actions/github-script@v7
        with:
          script: |
            // Get current labels on the PR
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            // Filter for auto-applied labels
            const autoLabels = currentLabels.filter(label => 
              label.name.startsWith('area:') || 
              label.name.startsWith('size:') ||
              label.name.startsWith('type:')
            );
            
            if (autoLabels.length > 0) {
              const areaLabels = autoLabels.filter(l => l.name.startsWith('area:')).map(l => `\`${l.name}\``);
              const sizeLabels = autoLabels.filter(l => l.name.startsWith('size:')).map(l => `\`${l.name}\``);
              const typeLabels = autoLabels.filter(l => l.name.startsWith('type:')).map(l => `\`${l.name}\``);
              
              let comment = `## ğŸ·ï¸ Auto-Labels Applied\n\n`;
              comment += `I've automatically analyzed this PR and applied the following labels:\n\n`;
              
              if (areaLabels.length > 0) {
                comment += `**ğŸ“‚ Code Areas:** ${areaLabels.join(', ')}\n`;
              }
              if (sizeLabels.length > 0) {
                comment += `**ğŸ“ PR Size:** ${sizeLabels.join(', ')}\n`;
              }
              if (typeLabels.length > 0) {
                comment += `**ğŸ¯ PR Type:** ${typeLabels.join(', ')}\n`;
              }
              
              comment += `\nğŸ“Š **PR Stats:**\n`;
              comment += `- ğŸ“ Files changed: ${{ steps.changed-files.outputs.total_files }}\n`;
              comment += `- â• Lines added: ${{ steps.changed-files.outputs.lines_added }}\n`;
              comment += `- â– Lines deleted: ${{ steps.changed-files.outputs.lines_deleted }}\n`;
              
              comment += `\n---\n`;
              comment += `<sub>ğŸ¤– Auto-labeling â€¢ Labels will help reviewers understand the scope of changes</sub>`;
              
              // Check if we already have an auto-labeling comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              const existingComment = comments.find(c => 
                c.user.type === 'Bot' && c.body.includes('ğŸ·ï¸ Auto-Labels Applied')
              );
              
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
                console.log('âœ… Updated existing auto-labeling comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
                console.log('âœ… Created new auto-labeling comment');
              }
            }

      - name: âœ… Auto-labeling complete
        run: |
          echo "ğŸ‰ Auto-labeling completed successfully!"
          echo "ğŸ“Š Analysis Summary:"
          echo "  ğŸ“ Total files: ${{ steps.changed-files.outputs.total_files }}"
          echo "  â• Lines added: ${{ steps.changed-files.outputs.lines_added }}"
          echo "  â– Lines deleted: ${{ steps.changed-files.outputs.lines_deleted }}"
          echo "  ğŸ¯ Areas detected based on file patterns"
          echo "  ğŸ·ï¸ Labels automatically applied"
