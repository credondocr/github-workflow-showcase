name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

# Ensure only one workflow runs at a time for the same PR
concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Quick validation for draft PRs
  quick-check:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ”§ Verify go mod tidy
        run: |
          go mod tidy
          if ! git diff --exit-code go.mod go.sum; then
            echo "âŒ go.mod or go.sum is not tidy. Please run 'go mod tidy' and commit the changes."
            exit 1
          fi

      - name: ğŸ—ï¸ Quick build check
        run: go build -v ./...

  # Essential checks that must pass
  essential-checks:
    name: âœ… Essential Checks
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: quick-check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ¨ Format check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "âŒ Code is not properly formatted. Files that need formatting:"
            gofmt -s -l .
            echo "Please run 'gofmt -s -w .' to fix formatting issues."
            exit 1
          fi
          echo "âœ… Code formatting is correct"

      - name: ğŸ” Basic linting
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --timeout=3m --fast

      - name: ğŸ§ª Run tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          go test -v -race ./...
          echo "âœ… All tests passed"

      - name: ğŸ§ª Run Ginkgo tests
        run: |
          echo "ğŸ§ª Running Ginkgo BDD tests..."
          go test -v ./tests/
          echo "âœ… All Ginkgo tests passed"

  # PR size and complexity check
  pr-analysis:
    name: ğŸ“Š PR Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Analyze PR size
        run: |
          # Get the base branch
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          # Count changes
          LINES_ADDED=$(git diff --numstat $BASE_SHA..$HEAD_SHA | awk '{sum+=$1} END {print sum+0}')
          LINES_DELETED=$(git diff --numstat $BASE_SHA..$HEAD_SHA | awk '{sum+=$2} END {print sum+0}')
          FILES_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | wc -l)
          
          echo "ğŸ“Š PR Analysis Results:"
          echo "ğŸ“ Files changed: $FILES_CHANGED"
          echo "â• Lines added: $LINES_ADDED"
          echo "â– Lines deleted: $LINES_DELETED"
          echo "ğŸ“ Net change: $((LINES_ADDED - LINES_DELETED))"
          
          # Size classification
          TOTAL_CHANGES=$((LINES_ADDED + LINES_DELETED))
          if [ $TOTAL_CHANGES -lt 50 ]; then
            echo "ğŸ“¦ PR Size: XS (< 50 lines) âœ…"
          elif [ $TOTAL_CHANGES -lt 200 ]; then
            echo "ğŸ“¦ PR Size: Small (< 200 lines) âœ…"
          elif [ $TOTAL_CHANGES -lt 500 ]; then
            echo "ğŸ“¦ PR Size: Medium (< 500 lines) âš ï¸"
            echo "ğŸ’¡ Consider breaking this into smaller PRs if possible"
          elif [ $TOTAL_CHANGES -lt 1000 ]; then
            echo "ğŸ“¦ PR Size: Large (< 1000 lines) âš ï¸"
            echo "âš ï¸ Large PRs are harder to review. Consider breaking into smaller pieces."
          else
            echo "ğŸ“¦ PR Size: XL (>= 1000 lines) âŒ"
            echo "âŒ This PR is very large and should be broken down into smaller PRs"
            exit 1
          fi

      - name: ğŸ” Check for test files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          # Check if any Go files were added/modified
          GO_FILES_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '\.go$' | grep -v '_test\.go$' | wc -l)
          TEST_FILES_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '_test\.go$' | wc -l)
          
          echo "ğŸ“ Go files changed: $GO_FILES_CHANGED"
          echo "ğŸ§ª Test files changed: $TEST_FILES_CHANGED"
          
          if [ $GO_FILES_CHANGED -gt 0 ] && [ $TEST_FILES_CHANGED -eq 0 ]; then
            echo "âš ï¸ Warning: Go code was modified but no test files were updated"
            echo "ğŸ’¡ Consider adding or updating tests for your changes"
          else
            echo "âœ… Good! Test files are included in this PR"
          fi

  # Security scan for PRs
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: ğŸ›¡ï¸ Run security scan
        run: |
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
          gosec -fmt json -out gosec-report.json -severity medium ./...
          
          # Check if any issues were found
          ISSUES=$(cat gosec-report.json | jq '.Stats.files_scanned')
          if [ "$ISSUES" != "null" ]; then
            echo "ğŸ”’ Security scan completed"
            cat gosec-report.json | jq '.Stats'
          fi

  # Check for breaking changes
  breaking-changes:
    name: ğŸ’¥ Breaking Changes Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for potential breaking changes
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          echo "ğŸ” Checking for potential breaking changes..."
          
          # Check for deleted exported functions/types
          DELETED_EXPORTS=$(git diff $BASE_SHA..$HEAD_SHA | grep "^-" | grep -E "^-func [A-Z]|^-type [A-Z]|^-var [A-Z]|^-const [A-Z]" | wc -l)
          
          # Check for modified function signatures
          MODIFIED_SIGNATURES=$(git diff $BASE_SHA..$HEAD_SHA | grep -E "^[-+]func [A-Z]" | wc -l)
          
          if [ $DELETED_EXPORTS -gt 0 ]; then
            echo "âš ï¸ Warning: $DELETED_EXPORTS exported items may have been deleted"
            echo "ğŸ’¡ This could be a breaking change. Please verify backwards compatibility."
          fi
          
          if [ $MODIFIED_SIGNATURES -gt 0 ]; then
            echo "âš ï¸ Warning: $MODIFIED_SIGNATURES function signatures may have been modified"
            echo "ğŸ’¡ Please ensure these changes are backwards compatible."
          fi
          
          if [ $DELETED_EXPORTS -eq 0 ] && [ $MODIFIED_SIGNATURES -eq 0 ]; then
            echo "âœ… No obvious breaking changes detected"
          fi

  # Final status check
  pr-ready:
    name: ğŸ¯ PR Ready for Review
    runs-on: ubuntu-latest
    needs: [essential-checks, pr-analysis, security-scan, breaking-changes]
    if: success() && github.event.pull_request.draft == false
    steps:
      - name: ğŸ‰ PR is ready
        run: |
          echo "ğŸ‰ All PR checks passed successfully!"
          echo "âœ… Code quality: PASSED"
          echo "âœ… Tests: PASSED"
          echo "âœ… Security: PASSED"
          echo "âœ… Analysis: PASSED"
          echo ""
          echo "ğŸš€ This PR is ready for human review!"

  # Comment on PR with results
  comment-results:
    name: ğŸ’¬ Comment Results
    runs-on: ubuntu-latest
    needs: [essential-checks, pr-analysis, security-scan, breaking-changes]
    if: always() && github.event.pull_request.draft == false
    steps:
      - name: ğŸ’¬ Comment PR status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });
            
            const success = checkRuns.check_runs.every(run => 
              run.conclusion === 'success' || run.conclusion === 'neutral'
            );
            
            const message = success ? 
              `ğŸ‰ **All PR checks passed!** This PR is ready for review.
              
              âœ… Code quality checks passed
              âœ… All tests passed  
              âœ… Security scan completed
              âœ… PR analysis completed
              
              Great work! ğŸš€` :
              `âš ï¸ **Some PR checks failed.** Please review and fix the issues.
              
              Check the Actions tab for detailed information about failures.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
